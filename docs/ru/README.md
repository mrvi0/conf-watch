# ConfWatch - Мониторинг конфигурационных файлов

[![Python](https://img.shields.io/badge/Python-3.7+-blue.svg)](https://python.org)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

[English](../../README.md) | [Русский](README.md)

```
██████╗ ██████╗ ███╗   ██╗███████╗██╗    ██╗ █████╗ ████████╗ ██████╗██╗  ██╗
██╔════╝██╔═══██╗████╗  ██║██╔════╝██║    ██║██╔══██╗╚══██╔══╝██╔════╝██║  ██║
██║     ██║   ██║██╔██╗ ██║█████╗  ██║ █╗ ██║███████║   ██║   ██║     ███████║
██║     ██║   ██║██║╚██╗██║██╔══╝  ██║███╗██║██╔══██║   ██║   ██║     ██╔══██║
╚██████╗╚██████╔╝██║ ╚████║██║     ╚███╔███╔╝██║  ██║   ██║   ╚██████╗██║  ██║
 ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝      ╚══╝╚══╝ ╚═╝  ╚═╝   ╚═╝    ╚═════╝╚═╝  ╚═╝
```

ConfWatch — это инструмент на Python для мониторинга и версионирования конфигурационных файлов. Он предоставляет мощный CLI и веб-интерфейс в стиле терминала для управления изменениями конфигурационных файлов, историей и различиями. **Теперь с безопасной авторизацией - каждая установка получает уникальный пароль!**

---

## Содержание
- [Возможности](#возможности)
- [Установка](#установка)
  - [Установка одной командой (рекомендуется)](#установка-одной-командой-рекомендуется)
  - [Установка для разработки](#установка-для-разработки)
- [Конфигурация](#конфигурация)
- [Использование CLI](#использование-cli)
- [Веб-интерфейс](#веб-интерфейс)
- [Снапшоты, безопасные имена и хранение файлов](#снапшоты-безопасные-имена-и-хранение-файлов)
- [Структура директорий](#структура-директорий)
- [Устранение неполадок](#устранение-неполадок)
- [FAQ](#faq)
- [Разработка](#разработка)
- [Лицензия](#лицензия)

---

## Возможности
- **Мониторинг любых конфигурационных файлов** (dotfiles, .env, /etc/*, и т.д.)
- **Автоматическое версионирование** (на основе Git, для каждого файла, с уникальными безопасными именами)
- **История для каждого файла** (просмотр всех изменений с датой и комментарием)
- **Сравнение любых двух снапшотов** (выбор любых двух версий для сравнения)
- **Веб-интерфейс в стиле терминала** (для удобного просмотра и сравнения различий)
- **Пользовательские чекбоксы и элементы управления** (все оформлены в стиле терминала)
- **Анимированная демонстрация CLI в веб-интерфейсе** (живые примеры использования)
- **Безопасная авторизация** (уникальный пароль для каждой установки)
- **Автоматический мониторинг файлов** (режимы watchdog + polling с daemon)
- **Удаленный доступ к веб-интерфейсу** (доступ с любого IP, не только localhost)
- **Простая установка/удаление** (пользовательский и режим разработки)
- **Изолированное виртуальное окружение** (без загрязнения системного Python)

---

## Установка

### Установка одной командой (рекомендуется для пользователей)

```bash
curl -fsSL https://raw.githubusercontent.com/yourusername/conf-watch/main/install.sh | bash
```

- Устанавливается в `~/.confwatch/`
- Добавляет `confwatch` в PATH (через .bashrc/.zshrc)
- Создает виртуальное окружение, конфигурацию, репозиторий, веб-интерфейс, launcher
- Все зависимости устанавливаются автоматически

### Установка для разработки (для участников)

```bash
git clone https://github.com/yourusername/conf-watch.git
cd conf-watch
./install-dev.sh
```
- Устанавливается в `~/.confwatch/` (но использует локальные исходники)
- Для разработки, тестирования и PR

---

## Конфигурация

Отредактируйте `~/.confwatch/config/config.yml`, чтобы указать файлы для мониторинга:

```yaml
# Список файлов для мониторинга (по одному на строку, начиная с -)
- ~/.bashrc
- ~/.zshrc
- ~/.ssh/config
- ~/.env
- /etc/nginx/nginx.conf
```

- Вы можете использовать `~` и переменные окружения в путях.
- После редактирования конфигурации запустите `confwatch snapshot` для создания начальных версий.

---

## Использование CLI

```bash
confwatch list                    # Список отслеживаемых файлов
confwatch snapshot [files...]     # Создать снапшоты (все или конкретные файлы)
confwatch snapshot --comment "msg" # Создать снапшот с комментарием
confwatch diff <file>             # Показать различия (последняя vs предыдущая)
confwatch history <file>          # Показать историю файла (с хешами коммитов)
confwatch tag <file> <tag>        # Пометить текущую версию тегом
confwatch rollback <file> <ver>   # Откат к конкретной версии
confwatch web [options]           # Запустить веб-интерфейс (разово)
confwatch web-daemon start        # Запустить постоянный веб-daemon
confwatch web-daemon stop         # Остановить постоянный веб-daemon
confwatch web-daemon status       # Показать статус веб-daemon
confwatch daemon start            # Запустить автоматический мониторинг файлов
confwatch daemon stop             # Остановить автоматический мониторинг файлов
confwatch daemon status           # Показать статус daemon
confwatch completion --install    # Установить автодополнение shell
confwatch reset-password          # Сбросить пароль веб-интерфейса
confwatch update                  # Обновить ConfWatch до последней версии
confwatch --help                  # Показать все команды
```

#### Примеры
```bash
confwatch snapshot ~/.bashrc --comment "После установки nvm"
confwatch snapshot --comment "Ежедневное резервное копирование" --force
confwatch diff ~/.env
confwatch history /etc/nginx/nginx.conf
confwatch tag ~/.bashrc "после-установки-nvm"
confwatch rollback ~/.bashrc abc1234
confwatch web --port 9000                # Разовый веб-сервер
confwatch web-daemon start --port 8080  # Постоянный веб-daemon
confwatch web-daemon config --port 9000 # Настроить веб-daemon
confwatch daemon start --foreground     # Запуск мониторинга в foreground
confwatch daemon start --polling        # Использовать polling вместо watchdog
confwatch daemon restart
confwatch completion bash --install     # Установить bash автодополнение
confwatch completion zsh --install      # Установить zsh автодополнение
confwatch update --force                # Принудительное обновление
confwatch reset-password --force
```

---

## Веб-интерфейс

- Запустите с помощью `confwatch web` (по умолчанию: http://0.0.0.0:8080)
- **Удаленный доступ** - доступен с любого IP-адреса, не только localhost
- **Безопасная авторизация** - каждая установка получает уникальный пароль
- Просматривайте все отслеживаемые файлы, статус и историю
- Нажмите [HISTORY] для просмотра всех снапшотов файла
- Выберите любые два снапшота и нажмите [SHOW DIFF] для сравнения
- Все элементы управления (чекбоксы, кнопки) оформлены как в терминале
- Анимированная демонстрация CLI вверху (показывает примеры использования)
- Кнопка выхода в заголовке терминала

**[SCREENSHOT PLACEHOLDER: Главный веб-интерфейс со списком файлов, статусом и анимированной демонстрацией CLI]**
**[SCREENSHOT PLACEHOLDER: Просмотр истории файла с пользовательскими чекбоксами и кнопкой [SHOW DIFF]]**
**[SCREENSHOT PLACEHOLDER: Просмотр различий между двумя произвольными снапшотами]**

---

## Постоянный Веб-Daemon

Для продакшн использования вы можете запустить постоянный веб-сервер daemon, который запускается автоматически и запоминает свою конфигурацию:

### Настройка и запуск
```bash
confwatch web-daemon config --host 0.0.0.0 --port 8080  # Настроить параметры
confwatch web-daemon start                              # Запустить в фоне
```

### Управление
```bash
confwatch web-daemon status      # Проверить статус
confwatch web-daemon stop        # Остановить daemon
confwatch web-daemon restart     # Перезапустить с сохраненной конфигурацией
```

### Возможности
- **Постоянная конфигурация** - настройки сохраняются в `~/.confwatch/web_daemon.conf`
- **Фоновая работа** - работает как daemon с управлением PID файлом
- **Автоперезапуск** - запоминает host, port, debug настройки
- **Логирование** - вывод идет в `~/.confwatch/web_daemon.log`
- **Управление процессами** - правильный start/stop/restart с отслеживанием PID

### Отличие от обычной команды web
- **`confwatch web`** - разовый сервер с параметрами командной строки
- **`confwatch web-daemon`** - постоянный daemon с сохраненной конфигурацией

---

## Автодополнение Shell

ConfWatch поддерживает умное автодополнение для bash и zsh:

### Автоматическая установка
Автодополнение устанавливается автоматически при установке ConfWatch. Если нужно переустановить или установить вручную:

```bash
confwatch completion --install          # Авто-определение shell и установка
confwatch completion bash --install     # Установка для bash
confwatch completion zsh --install      # Установка для zsh
```

### Возможности
- **Дополнение команд** - `confwatch <TAB>` показывает все доступные команды
- **Дополнение подкоманд** - `confwatch web-daemon <TAB>` показывает start, stop, restart и т.д.
- **Дополнение опций** - `confwatch daemon start --<TAB>` показывает доступные флаги
- **Дополнение путей** - `confwatch snapshot <TAB>` дополняет пути к файлам
- **Контекстно-зависимое** - разные опции для разных команд и подкоманд

### Ручная установка
Если автоматическая установка не сработала, можно установить вручную:

```bash
# Генерация файлов автодополнения
confwatch completion --output /tmp/completion

# Ручная установка
sudo cp /tmp/completion/confwatch-completion.bash /usr/share/bash-completion/completions/confwatch
sudo cp /tmp/completion/_confwatch /usr/share/zsh/site-functions/_confwatch
```

После установки перезапустите shell или выполните:
- **Bash**: `source ~/.bashrc`
- **Zsh**: `compinit`

---

## Автоматический мониторинг файлов

ConfWatch может автоматически отслеживать ваши конфигурационные файлы и создавать снапшоты при их изменении:

### Запуск мониторинга
```bash
confwatch daemon start              # Запуск в фоне (рекомендуется)
confwatch daemon start --foreground # Запуск в foreground для отладки
confwatch daemon start --polling    # Использовать polling вместо watchdog
```

### Статус мониторинга
```bash
confwatch daemon status             # Проверить, запущен ли daemon
```

### Остановка мониторинга
```bash
confwatch daemon stop               # Остановить фоновый мониторинг
confwatch daemon restart            # Перезапустить daemon
```

### Как это работает
- **Режим Watchdog** (по умолчанию): Использует системные события файлов (inotify на Linux) для мгновенного обнаружения
- **Режим Polling** (резервный): Проверяет файлы каждые 30 секунд с помощью сравнения хешей
- **Debouncing**: Ждет 5 секунд после последнего изменения перед созданием снапшота
- **Авто-комментарии**: Снапшоты получают префикс `[AUTO]` с временной меткой
- **Умная фильтрация**: Игнорирует временные файлы (.swp, .tmp, .bak и т.д.)

### Логи
- **PID файл**: `~/.confwatch/daemon.pid`
- **Лог файл**: `~/.confwatch/daemon.log`
- **Фоновый режим**: Весь вывод идет в лог файл
- **Foreground режим**: Вывод в терминал

---

## Снапшоты, безопасные имена и хранение файлов

- **Каждый файл** отслеживается по абсолютному пути, но хранится в репозитории с уникальным "безопасным именем":
  - `safe_name = sha256(abs_path) + '_' + filename`
  - Это предотвращает конфликты для файлов с одинаковыми именами в разных папках.
- **В UI и CLI** вы всегда видите оригинальный путь к файлу и короткие хеши git коммитов.
- **В репозитории** вы можете видеть длинные имена файлов — это нормально и обеспечивает уникальность.
- **Снапшоты** — это git коммиты, каждый с хешем, датой и опциональным комментарием.
- **Различия** можно показать между любыми двумя снапшотами (не только последний vs предыдущий).

---

## Структура директорий

После установки у вас будет:

```
~/.confwatch/
├── venv/                # Виртуальное окружение Python
├── config/config.yml    # Список отслеживаемых файлов
├── repo/                # Git репозиторий со всеми версиями файлов (безопасные имена)
├── web/                 # Статические файлы веб-интерфейса
├── confwatch            # Launcher скрипт (добавлен в PATH)
└── confwatch-module/    # Весь Python код (core, cli, web)
```

---

## Устранение неполадок

- **confwatch: command not found**
  - Запустите `source ~/.bashrc` или перезапустите терминал
  - Убедитесь, что `~/.confwatch/` находится в PATH
- **Python/pip/git not found**
  - Установите Python 3.7+, pip и git
- **Веб-интерфейс не открывается**
  - Убедитесь, что ничего не использует порт 8080 (или используйте `confwatch web --port 9000`)
- **Ошибки прав доступа**
  - Убедитесь, что у вас есть права на запись в `~/.confwatch`
- **Как удалить?**
  - Запустите `./uninstall.sh` из репозитория или удалите `~/.confwatch` и очистите PATH в конфигурации shell

---

## FAQ

**В: Почему некоторые файлы в репозитории названы с длинным хешем?**
О: Это "безопасное имя" — уникальный идентификатор для каждого файла, основанный на его абсолютном пути. Это предотвращает конфликты между файлами с одинаковыми именами в разных папках. В UI и CLI вы всегда видите оригинальный путь к файлу и короткие хеши коммитов.

**В: Как сравнить любые два снапшота?**
О: В веб-интерфейсе откройте HISTORY для файла, выберите любые две версии и нажмите [SHOW DIFF].

**В: Как обновить ConfWatch?**
О: Получите последний код и запустите `./install.sh` снова.

**В: Как добавить/удалить файлы из мониторинга?**
О: Отредактируйте `~/.confwatch/config/config.yml` и запустите `confwatch snapshot`.

**В: Как использовать другой порт для веб-интерфейса?**
О: `confwatch web --port 9000`

**В: Как сбросить пароль веб-интерфейса?**
О: `confwatch reset-password` (с подтверждением) или `confwatch reset-password --force`

**В: Что делать, если я забыл пароль веб-интерфейса?**
О: Используйте `confwatch reset-password` для генерации нового.

**В: Как работает автоматический мониторинг?**
О: Запустите `confwatch daemon start` для мониторинга файлов. Использует watchdog (inotify) для мгновенного обнаружения или переключается на polling каждые 30 секунд. Создает снапшоты автоматически с префиксом `[AUTO]`.

**В: Могу ли я получить доступ к веб-интерфейсу с другого компьютера?**
О: Да! Веб-сервер привязывается к `0.0.0.0:8080` по умолчанию, что делает его доступным с любого IP. Просто убедитесь, что ваш брандмауэр разрешает порт.

**В: Как обновить ConfWatch?**
О: Запустите `confwatch update` для автоматического обновления до последней версии. Ваша конфигурация и история файлов сохраняются при обновлениях.

**В: В чем разница между web и web-daemon?**
О: `confwatch web` запускает разовый сервер, а `confwatch web-daemon` запускает постоянный daemon, который запоминает свою конфигурацию и может управляться как системный сервис.

**В: Как включить автодополнение?**
О: Автодополнение устанавливается автоматически. Если не работает, запустите `confwatch completion --install` и перезапустите shell.

**В: Как разрабатывать или участвовать?**
О: См. [Разработка](#разработка) ниже.

---

## Разработка

- Клонируйте репозиторий и запустите `./install-dev.sh` (см. выше)
- Весь код находится в `confwatch-module/` (core, cli, web)
- Веб-интерфейс находится в `confwatch/web/static/`
- Для запуска тестов: `python -m pytest`
- Для запуска веб-интерфейса в режиме разработки: `python -m confwatch.cli.main web --debug`
- PR и issues приветствуются!

---

## Лицензия

Проект распространяется под лицензией MIT — см. файл [LICENSE](../../LICENSE). 